version: '3'

tasks:
  init:
    desc: Initialize Terraform Resources
    dir: '{{.USER_WORKING_DIR}}'
    preconditions:
      - which gum
    cmds:
      - terraform init

  plan:
    desc: Plan Terraform Resources
    preconditions:
      - which gum
    dir: '{{.USER_WORKING_DIR}}'
    cmds:
      - terraform plan
      
  apply:
    silent: true
    desc: "Apply Terraform Resources"
    preconditions:
      - which gum
    dir: '{{.USER_WORKING_DIR}}'
    vars:
      STATIC_IPS:
        sh: awk -F'"' '/static_ip/ {print $2}' variables.tf | awk -F '/' '{print $1}' | xargs
    cmds:
      - echo "Provisioning Servers..."
      - terraform apply -auto-approve
      - echo "Provisioning done! Static IPs are:"
      - for: { var: STATIC_IPS }
        cmd: echo {{ .ITEM}}

  destroy:
    desc: Destroy all resources in current project
    preconditions:
      - which gum
    dir: '{{.USER_WORKING_DIR}}'
    cmds:
      - terraform destroy -auto-approve